--[[
	コントラスト比計算.obj (WIP)
	Copyright (c) 2022 CaffemochaY

	色のコントラスト比を計算するものです
	[WCAG 2.0](https://www.w3.org/TR/WCAG20-TECHS/G17.html#G17-procedure)
]]

--[[
	<ideas>

	- フォントに合わせた背景にするために、obj.loadしたテキストのサイズを取得し、背景サイズを決める / 固定にも出来るようにしたい > 71
	- アンカーをつけて、そこの色の平均値をとる
		- 範囲選択 / 範囲指定
]]

--dialog:文字色/col,local dp1=0xffffff;背景色/col,local dp2=0x000000;font_size,local dp3=34;font,local dp4="MS UI Gothic";

local ct = {}
ct["col1"] = {}
ct["col2"] = {}

ct["col1"]["ori"] = dp1 or 0xffffff
ct["col2"]["ori"] = dp2 or 0x000000
local font_size = dp3 or 34
local font = dp4 or "MS UI Gothic"

-- rgb分解
ct["col1"]["r"] = math.floor(ct["col1"]["ori"] / 65536)
ct["col1"]["g"] = math.floor((ct["col1"]["ori"] - ct["col1"]["r"] * 65536) / 256)
ct["col1"]["b"] = (ct["col1"]["ori"] - ct["col1"]["r"] * 65536 - ct["col1"]["g"] * 256)
ct["col2"]["r"] = math.floor(ct["col2"]["ori"] / 65536 )
ct["col2"]["g"] = math.floor((ct["col2"]["ori"] - ct["col2"]["r"] * 65536) / 256)
ct["col2"]["b"] = (ct["col2"]["ori"] - ct["col2"]["r"] * 65536 - ct["col2"]["g"] * 256)

-- 正規化
ct["col1"]["rs"] = ct["col1"]["r"] / 255
ct["col1"]["gs"] = ct["col1"]["g"] / 255
ct["col1"]["bs"] = ct["col1"]["b"] / 255
ct["col2"]["rs"] = ct["col2"]["r"] / 255
ct["col2"]["gs"] = ct["col2"]["g"] / 255
ct["col2"]["bs"] = ct["col2"]["b"] / 255

-- 輝度計算
local function lum_cal(colset, coltype)
	if ct["col"..colset][coltype.."s"] <= 0.03928 then
		ct["col"..colset][coltype.."l"] = ct["col"..colset][coltype.."s"] / 12.92
	else
		ct["col"..colset][coltype.."l"] = ((ct["col"..colset][coltype.."s"] + 0.055) / 1.055) ^ 2.4
	end
end

lum_cal("1", "r")
lum_cal("1", "g")
lum_cal("1", "b")
lum_cal("2", "r")
lum_cal("2", "g")
lum_cal("2", "b")

local ct_col1_l = ct["col1"]["rl"] * 0.2126 + ct["col1"]["gl"] * 0.7152 + ct["col1"]["bl"] * 0.0722
local ct_col2_l = ct["col2"]["rl"] * 0.2126 + ct["col2"]["gl"] * 0.7152 + ct["col2"]["bl"] * 0.0722

local contrast_rate = (ct_col1_l + 0.05) / (ct_col2_l + 0.05)

-- 1未満のとき、逆数をとるようにする
if contrast_rate < 1 then
	contrast_rate = 1 / contrast_rate
end

obj.load("figure", "四角形", ct["col2"]["ori"], 1)
obj.drawpoly(-font_size * 4.2, -font_size * 0.6, 0, font_size * 4.2, -font_size * 0.6, 0, font_size * 4.2, font_size * 0.6, 0, -font_size * 4.2, font_size * 0.6, 0)

obj.setfont(font, font_size, 0, ct["col1"]["ori"])
obj.load("text", contrast_rate)
obj.effect() -- 一応縁取りとかして確認するかもなので
obj.draw()
